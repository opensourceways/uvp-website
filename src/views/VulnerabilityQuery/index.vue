<template>
  <div class="VulnerabilityQuery-container">
    <div class="header-top">
      <div class="title">漏洞查询</div>
      <el-input 
        v-model="keyword" 
        placeholder="输入purl、软件包名称、漏洞编号，按enter键搜索" 
        clearable
        :suffix-icon="Search"
        @keyup.enter="search"
      />
    </div>
    <div class="table">
      <uvpTable 
       :tableData="tableData"
       :columns="columns"
       @goPath="goPath"
      />
      <div class="pagination">
        <el-select v-model="pageSize" @change="search">
          <el-option
            v-for="item in pageSizes"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          />
        </el-select>
        <el-button type="text" :disabled="pageNum === 0" @click="handleCurrentPage('pre')">上一页</el-button>
        <el-button type="text" :disabled="lastPage" @click="handleCurrentPage('next')">下一页</el-button>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import { defineComponent, ref } from "vue";
import SbomDataService from "@/services/SbomDataService";
import { Search } from '@element-plus/icons-vue'
import { ElMessage } from 'element-plus';
import ResponseData from "@/types/ResponseData";
import { mapGetters} from 'vuex';
import uvpTable from '@/components/uvpTable.vue';
export default defineComponent({
  name: "vulnerabilityQuery",
  components: {
    uvpTable
  },
  props: {
    
  },
  data() {
    return {
      Search: Search,
      pageNum: 0,
      pageSize: 10,
      pageSizes: [
        { label: '10条/页', value: 10 },
        { label: '15条/页', value: 15 },
        { label: '20条/页', value: 20 },
        { label: '50条/页', value: 50 },
        { label: '100条/页', value: 100 },
      ],
      tableData: [] as any,
      lastPage: false,
      columns: [
        { label: '编号', prop: 'vulnId', type: 'link', fnName: 'goPath', width: '200' },
        { label: '摘要', prop: 'summary', showTooltip: true },
        { label: '评分', prop: 'score', hasBgcolor: true, colorProp: 'severity', width: '100' },
        { label: '发布时间', prop: 'published', width: '250' },
        { label: '修改时间', prop: 'modified', width: '250' },
        { label: '影响软件包', prop: 'affectedPackages', type: 'arrayInline', imgSrc: require('@/assets/images/file.png') },
        { label: '是否存在修复', prop: 'fixedTxt', hasTxtColor: true, colorProp: 'fixed', width: '150' }
      ],
      keyword: ''
    };
  },
  computed:{
    ...mapGetters([])
  },
  watch: {
  },
  methods: {
    search() {
      this.pageNum = 0
      this.getDataList()
    },
    handleCurrentPage(type) {
      if(type === 'pre') {
        this.pageNum --
      } else {
        this.pageNum ++
      }
      this.getDataList()
    },
    getDataList() {
      const data = {
        keyword: this.keyword,
        page: this.pageNum,
        size: this.pageSize
      }
      SbomDataService.queryVulnerability(data)
        .then((response: ResponseData) => {
          const { vulns, lastPage } = response.data
          this.tableData = vulns.length && vulns.map(item => {
            return {
              ...item,
              fixedTxt: item.fixed ? '是' : '否'
            }
          })
          this.lastPage = lastPage
        })
        .catch((e: any) => {
          if (e.response && e.response.status == 500) {
            ElMessage({
              message: e.response.data,
              type: 'error'
            })
          }
          this.tableData = []
          this.pageNum = 0
        });
    },
    goPath(info) {
      const { href } = this.$router.resolve({
        path: '/vulnerabilityDetail',
        query: {
          vulnId: info.data.vulnId
        }
      })
      window.open(href, '_blank')
    }
  },
  mounted() {
    this.getDataList()
  },
});
</script>

<style lang="less" scoped>
.VulnerabilityQuery-container{
  margin: 20px 30px;
  background-color: #ffffff;
  border-radius: 4px;
  padding: 15px 25px;
  .header-top{
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 18px;
    .title{
      font-size: 16px;
      font-weight: bold;
      color: #000000;
    }
    .el-input{
      width: 380px;
      /deep/.el-input__inner{
        height: 36px;
        font-size: 14px;
        &::placeholder {
          color: #CFD5E3;
          // font-size: 14px;
        }
      }
    }
  }
  .table{
    .pagination{
      margin-top: 30px;
      display: flex;
      justify-content: flex-end;
      .el-select{
        width: 95px;
        margin-right: 15px;
        /deep/.el-input__inner{
          height: 30px;
          font-size: 12px;
        }
      }
    }
  }
}
</style>
<style lang="less">
.VulnerabilityQuery-container{
  .el-table__body-wrapper{
    max-height: calc(100vh - 330px);
    overflow: auto;
  }
}
</style>